<!DOCTYPE html>
<html>
  <head>
    <title>The Musical Turing Test</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .jspsych-content {
        font-size: 3em;
      }
    </style>
  </head>
  <body>
    <script>
      // Initialize jsPsych with on_finish
      var jsPsych = initJsPsych({
        on_finish: function() {
          // Debug: show all trial responses in console
          console.table(
            jsPsych.data.get()
              .filter({ trial_type: 'audio-keyboard-response' })
              .select(['stimulus', 'response', 'correct', 'rt'])
              .values()
          );
        }
      });

      var timeline = [];

      // --- Welcome ---
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to the experiment. Press any key to begin."
      });

      // --- Instructions ---
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <h2>Welcome to the experiment!</h2>
          <p>-----------------------------------------------------------</p>
          <p>You will hear a few short chorale phrases with a harpsichord sound.</p>
          <p>If you think the music was composed by a <strong>Human</strong>, press <strong>H</strong>.</p>
          <p>If you think the music was composed by <strong>Artificial Intelligence</strong>, press <strong>A</strong>.</p>
          <p>Press any key to begin.</p>
        `
      });

      // --- Audio files ---
      var audio_files = [];

      var human_files = [
        "data/122.6-4.xml",
        "data/148.6-6.xml",
        "data/175.5-5.xml",
        "data/227.11-5.xml",
        "data/244.15-6.xml",
        "data/256-5.xml",
        "data/276-8.xml",
        "data/283-7.xml",
        "data/290-2.xml",
        "data/292-2.xml",
        "data/294-4.xml",
        "data/325-5.xml",
        "data/368-7.xml",
        "data/375-1.xml",
        "data/402-8.xml",
        "data/426-6.xml",
        "data/428-3.xml",
        "data/5.7-2.xml",
        "data/65.7-5.xml",
        "data/90.5-6.xml"
      ];
      human_files.forEach(f => audio_files.push({file: f, label: "h"}));

      var ai_files = [
        "data/output10-6.xml",
        "data/output14-6.xml",
        "data/output16-1.xml",
        "data/output19-1.xml",
        "data/output21-1.xml",
        "data/output26-4.xml",
        "data/output28-2.xml",
        "data/output3-3.xml",
        "data/output31-5.xml",
        "data/output39-6.xml",
        "data/output48-2.xml",
        "data/output58-3.xml",
        "data/output61-3.xml",
        "data/output64-3.xml",
        "data/output67-3.xml",
        "data/output70-1.xml",
        "data/output75-1.xml",
        "data/output77-3.xml",
        "data/output79-3.xml",
        "data/output80-2.xml",
        "data/output81-3.xml"
      ];
      ai_files.forEach(f => audio_files.push({file: f, label: "a"}));

      // Shuffle
      var shuffled_files = jsPsych.randomization.shuffle(audio_files);

      // --- Create trials ---
      for (let i = 0; i < shuffled_files.length; i++) {
        let trial_info = shuffled_files[i];
        timeline.push({
          type: jsPsychAudioKeyboardResponse,
          stimulus: trial_info.file,
          choices: ["a","h"],
          prompt: `
            <p>Was this composed by a human (<strong>H</strong>) or by artificial intelligence (<strong>A</strong>)?</p>
            <p style="margin-top:10px; font-weight:bold;">Trial ${i+1} / ${shuffled_files.length}</p>
          `,
          data: { correct: trial_info.label, label:trial_info.label },
          response_ends_trial: true
        });
      }

      // --- Final screen ---
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const trials = jsPsych.data.get()
            .filter({ trial_type: 'audio-keyboard-response' })
            .values(); // plain array

          const correct_trials = trials.filter(t => t.response?.toLowerCase() === t.correct?.toLowerCase()).length;
          const total_trials = trials.length;
          const accuracy = Math.round((correct_trials / total_trials) * 100);

          return `
            <h2>Thank you for participating!</h2>
            <p>Your score: ${correct_trials} / ${total_trials} (${accuracy}%) correct</p>
            <p>Press any key to finish.</p>
          `;
        }
      });

      // --- Run the experiment ---
      jsPsych.run(timeline);
    </script>
  </body>
</html>

